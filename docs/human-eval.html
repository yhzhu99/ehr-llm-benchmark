<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¸´åºŠæ¨ç†é—®å·</title>
<style>
  :root{
    --bg:#f7fafc;
    --panel:#ffffff;
    --panel-2:#ffffff;
    --text:#0f172a;
    --muted:#475569;
    --accent:#2563eb;
    --accent-2:#1d4ed8;
    --ok:#16a34a;
    --warn:#d97706;
    --bad:#dc2626;
    --border:#e2e8f0;
    --chip:#f1f5f9;
    --chip-2:#eef2f7;
    --shadow:0 8px 24px rgba(15,23,42,0.08);
    --radius:14px;
    --active:#e8f1ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:14px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Inter,Roboto,"Helvetica Neue",Arial;
    color:var(--text);
    background:
      radial-gradient(800px 400px at 10% -10%, #dbeafe 0, transparent 60%),
      radial-gradient(800px 400px at 90% -10%, #e0e7ff 0, transparent 60%),
      var(--bg);
  }
  a{color:var(--accent); text-decoration:none}
  header{
    position:sticky; top:0; z-index:50; backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg,#ffffffcc,#ffffffbf);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1280px; margin:0 auto; padding:14px 18px}
  .topbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .brand{font-weight:800; letter-spacing:.2px; font-size:16px}
  .grow{flex:1}
  .btn,button{
    background:linear-gradient(180deg,#3b82f6,#2563eb);
    border:1px solid #1e40af; color:#fff; padding:10px 14px; border-radius:12px;
    cursor:pointer; box-shadow:var(--shadow);
    transition:.15s transform ease, .15s box-shadow ease, .15s filter ease;
    user-select:none;
  }
  .btn.secondary{
    background:linear-gradient(180deg,#f8fafc,#eef2f7);
    border:1px solid var(--border); color:#0f172a;
  }
  .btn.ghost{
    background:transparent; border:1px dashed var(--border); color:var(--muted); box-shadow:none;
  }
  .btn.linklike{
    background:transparent; border:1px solid var(--border); color:#0f172a; box-shadow:none;
  }
  .btn:disabled{opacity:.6; cursor:not-allowed; filter:grayscale(.2)}
  .btn:hover{transform:translateY(-1px)}
  select, input[type="text"], input[type="number"], textarea{
    width:100%; background:#fff; border:1px solid var(--border); color:var(--text);
    padding:10px 12px; border-radius:10px; outline:none; font-size:14px;
  }

  /* Tabs */
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center}
  .tab{
    padding:8px 12px; border-radius:999px; background:var(--chip);
    border:1px solid var(--border); color:#1f2937; cursor:pointer; user-select:none; box-shadow:var(--shadow)
  }
  .tab.active{
    color:#fff; background:linear-gradient(180deg,#3b82f6,#2563eb); border-color:#1e40af
  }
  .home-tab{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff;}

  /* View Mode Tabs */
  .view-mode-container{display: flex; gap: 10px; align-items: center; flex-wrap:wrap;}
  .view-mode-tab {padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer;}
  .view-mode-tab.active {background:#dbeafe; color:#1e3a8a; border-color:#93c5fd; font-weight:bold;}
  .sample-settings {display: flex; gap: 8px; align-items: center;}
  .sample-settings input[type="number"] {width: 70px; padding: 6px 8px;}


  main{display:grid; grid-template-columns:340px 1fr; gap:16px; padding:18px; max-width:1280px; margin:0 auto}
  @media (max-width:1000px){ main{grid-template-columns:1fr} .aside{order:2} .content{order:1} }
  .panel{
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .aside{
    padding:10px;
    position: sticky;
    top: 18px; /* Match parent's padding-top for alignment */
    align-self: start;
  }
  .searchbar{display:flex; gap:8px; padding:10px}
  .filters{display:flex; gap:8px; flex-wrap:wrap; padding:0 10px 10px}
  .toggle{
    border:1px solid var(--border); padding:8px 10px; border-radius:10px; background:#fff;
    color:#0f172a; cursor:pointer; user-select:none
  }
  .toggle.active{background:#dbeafe; color:#1e3a8a; border-color:#93c5fd}
  .list{max-height:calc(100vh - 300px); overflow:auto; padding:6px 6px 10px 6px}
  .item{
    border:1px solid var(--border); background:#fff; padding:10px; border-radius:12px; margin:6px; cursor:pointer;
    display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; transition:.1s border-color ease, .1s background ease, .1s box-shadow ease;
    position:relative;
  }
  .item::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:12px; border-bottom-left-radius:12px; background:transparent;
  }
  .item:hover{border-color:#93c5fd; background:#f8fbff}
  .item.active{border-color:#60a5fa; background:var(--active); box-shadow:0 0 0 2px #bfdbfe inset}
  .item.active::before{background:#3b82f6}
  .item .meta{font-size:12px; color:var(--muted)}
  .badge{padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
  .badge.ok{background:#ecfdf5; color:#065f46; border-color:#a7f3d0}
  .badge.todo{background:#eff6ff; color:#1e3a8a; border-color:#bfdbfe}
  .content{padding:14px 14px 20px}
  .casehead{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  .caseid{font-weight:800; font-size:18px}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:var(--chip); border:1px solid var(--border); color:#0f172a; padding:6px 10px; border-radius:999px; font-size:12px}
  details{border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff}
  details + details{margin-top:10px}
  summary{cursor:pointer; font-weight:700}
  pre{white-space:pre-wrap; word-break:break-word; background:#f8fafc; padding:10px; border-radius:10px; overflow:auto; border:1px solid var(--border); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .stars{display:flex; gap:6px; align-items:center}
  .star{font-size:22px; cursor:pointer; filter:drop-shadow(0 1px 4px rgba(0,0,0,.12))}
  .star.on{color:#f59e0b}
  /* ä¸‰é¡¹è¯„åˆ†åŒæ’ */
  .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  @media (max-width:920px){ .grid3{grid-template-columns:1fr} }
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:800px){ .grid2{grid-template-columns:1fr} }
  .checklist label{display:flex; gap:10px; align-items:flex-start; padding:8px; border:1px solid var(--border); border-radius:10px; background:#f8fafc}
  .savebar{
    position:sticky; bottom:0; background:#fffffff2; border-top:1px solid var(--border); padding:10px;
    display:flex; gap:10px; justify-content:space-between; align-items:center; border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius)
  }
  .muted{color:var(--muted)}
  .progress{width:180px; height:8px; background:#eef2f7; border-radius:999px; border:1px solid var(--border); overflow:hidden}
  .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#34d399)}
  .toast{
    position:fixed; right:16px; bottom:16px; background:#ffffff; border:1px solid var(--border); padding:10px 14px;
    border-radius:12px; box-shadow:var(--shadow); display:none
  }
  .pill{padding:2px 8px; background:#e2e8f0; border:1px solid var(--border); border-radius:999px; font-size:16px; color:#0f172a}
  .danger{color:var(--bad)}
  .hint{font-size:12px; color:var(--muted)}
  .top-actions{display:flex; gap:8px; align-items:center}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; background:#e2e8f0; padding:2px 6px; border-radius:6px; border:1px solid var(--border)}
  /* Modal */
  .modal-mask{position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:60}
  .modal{width:min(520px,92vw); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .modal h3{margin:0 0 10px 0}
  .modal .row{display:flex; gap:10px; align-items:center; margin-top:8px}
  .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand" id="brand">ğŸ©º ä¸´åºŠæ¨ç†é—®å·</div>
        <div class="grow"></div>
        <div id="viewModeContainer" class="view-mode-container"></div>
        <div class="grow"></div>
        <div class="top-actions">
          <span class="hint" id="autoStatus">æ­£åœ¨è‡ªåŠ¨æ‰«æ <span class="kbd">cases</span>â€¦</span>
          <a href="https://yhzhu99.github.io/ehr-llm-benchmark" class="btn linklike" title="å›åˆ°ä¸»é¡µ /">ğŸ  /</a>
          <button id="rescanBtn" class="btn ghost" title="é‡æ–°æ‰«ææ•°æ®ç›®å½•">ğŸ”„ é‡æ–°æ‰«æ</button>
          <div class="lang">
            <span class="hint">ğŸŒ</span>
            <select id="langSelect" style="width:auto">
              <option value="zh">ä¸­æ–‡</option>
              <option value="en">EN</option>
            </select>
          </div>
          <button id="exportBtn" class="btn secondary" disabled>â¬‡ï¸ æäº¤ / å¯¼å‡º</button>
          <button id="importBtn" class="btn ghost">â†©ï¸ å¯¼å…¥ç»“æœ</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
      <div class="tabs" id="tabs"></div>
    </div>
  </header>

  <main>
    <aside class="panel aside">
      <div class="searchbar">
        <input id="searchBox" type="text" placeholder="ğŸ” æœç´¢ç—…ä¾‹ IDã€æ¨¡å‹åã€æˆ–è·¯å¾„ç‰‡æ®µâ€¦" />
      </div>
      <div class="filters">
        <div id="toggleHideDone" class="toggle">åªçœ‹æœªå®Œæˆ</div>
        <div id="toggleShuffle" class="toggle">éšæœºé¡ºåº</div>
      </div>
      <div class="list" id="caseList"></div>
    </aside>

    <section class="panel content" id="content">
      <div style="padding:16px">
        <div class="muted" id="emptyMsg1">æ­£åœ¨æ‰«æ <code>cases/</code>â€¦ è‹¥é•¿æ—¶é—´æ— å“åº”ï¼Œè¯·ç¡®è®¤è¯¥ç›®å½•ä¸æœ¬é¡µé¢åŒæºå¯è®¿é—®ã€‚</div>
        <div class="hint" id="emptyMsg2">è·¯å¾„ç»“æ„ï¼š<code>cases/&lt;structured_ehr|unstructured_note&gt;/&lt;mimic-iv-mortality|mimic-iv-readmission&gt;/*.json</code></div>
      </div>
    </section>
  </main>

  <div class="wrap" style="padding-bottom:40px">
    <div class="panel" style="padding:14px">
      <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
        <div style="display:flex; gap:12px; align-items:center">
          <div class="muted" id="progressLabel">è¿›åº¦</div>
          <div class="progress"><i id="progressBar"></i></div>
          <div class="muted"><span id="progressText">0 / 0</span></div>
        </div>
        <div class="muted" id="storageHint">æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ LocalStorageã€‚å¯éšæ—¶å¯¼å‡ºä¸º JSONã€‚</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">å·²ä¿å­˜ âœ“</div>

  <!-- å¯¼å‡ºæ—¶å¡«å†™è¯„ä¼°è€…ä¿¡æ¯çš„å¼¹çª— -->
  <div class="modal-mask" id="exportModalMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="exportTitle">
      <h3 id="exportTitle">æäº¤ / å¯¼å‡º</h3>
      <div class="hint">è¯·å¡«å†™è¯„ä¼°è€…ä¿¡æ¯ï¼Œè¿™å°†å†™å…¥å¯¼å‡ºçš„ JSON ä¸­ã€‚</div>
      <div class="row">
        <label style="min-width:110px">è¯„ä¼°è€… ID / å§“å</label>
        <input id="annotatorInput" type="text" placeholder="å¦‚ï¼šDr. Zhang æˆ– user_001" />
      </div>
      <div class="row">
        <label style="min-width:110px">é™„åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <input id="exportNote" type="text" placeholder="ä¾‹å¦‚ï¼šç¬¬1è½®äººè¯„ã€å£å¾„v2 ç­‰" />
      </div>
      <div class="actions">
        <button class="btn ghost" id="exportCancel">å–æ¶ˆ</button>
        <button class="btn" id="exportConfirm">å¯¼å‡º JSON</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
 * Language & i18n
 * =========================== */
const LANG_KEY = "humeval_lang_v3";
const I18N = {
  zh: {
    brand:"ğŸ©º ä¸´åºŠæ¨ç†é—®å·",
    export:"â¬‡ï¸ æäº¤ / å¯¼å‡º",
    import:"â†©ï¸ å¯¼å…¥ç»“æœ",
    rescan:"ğŸ”„ é‡æ–°æ‰«æ",
    searchPH:"ğŸ” æœç´¢ç—…ä¾‹ IDã€æ¨¡å‹åã€æˆ–è·¯å¾„ç‰‡æ®µâ€¦",
    toggleHide:"åªçœ‹æœªå®Œæˆ",
    toggleShuffle:"éšæœºé¡ºåº",
    empty1:'æ­£åœ¨æ‰«æ <code>cases/</code>â€¦ è‹¥é•¿æ—¶é—´æ— å“åº”ï¼Œè¯·ç¡®è®¤è¯¥ç›®å½•ä¸æœ¬é¡µé¢åŒæºå¯è®¿é—®ã€‚',
    empty2:'è·¯å¾„ç»“æ„ï¼š<code>cases/&lt;structured_ehr|unstructured_note&gt;/&lt;mimic-iv-mortality|mimic-iv-readmission&gt;/*.json</code>',
    progressLabel:"è¿›åº¦",
    storageHint:"æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ LocalStorageã€‚å¯éšæ—¶å¯¼å‡ºä¸º JSONã€‚",
    listNo:"å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰ç—…ä¾‹ã€‚",
    done:"å®Œæˆ",
    todo:"æœªå®Œæˆ",
    model:"æ¨¡å‹",
    inputTitle:"ğŸ§¾ è¾“å…¥ï¼ˆæ‚£è€…ç—…ä¾‹ inputï¼‰",
    thinkTitle:"ğŸ§  æ¨¡å‹æ¨ç†ï¼ˆthinkï¼‰",
    alTitle:"âœ… æ¨¡å‹è¾“å‡ºï¼ˆanswerï¼‰ä¸çœŸå®æ ‡ç­¾ï¼ˆlabelï¼‰",
    rawTitle:"ğŸ§© åŸå§‹ JSON",
    rateTitles:["ä¸´åºŠå‡†ç¡®æ€§ä¸å®‰å…¨æ€§","æ¨ç†ä¸å®Œæ•´æ€§","æ¸…æ™°åº¦ä¸ä¸´åºŠå®ç”¨æ€§"],
    rateHint:"è¯„åˆ† 1ï¼ˆéå¸¸å·®ï¼‰â€” 5ï¼ˆéå¸¸ä¼˜ç§€ï¼‰ã€‚ç‚¹å‡»æ˜Ÿæ˜Ÿè®¾ç½®æˆ–ä¿®æ”¹ã€‚",
    checkTitle:"ğŸ” å…³é”®é”™è¯¯æ ¸æŸ¥æ¸…å•ï¼ˆå¯å¤šé€‰ï¼‰",
    checks:["äº‹å®ä¸ä¸€è‡´/å¹»è§‰","é—æ¼å…³é”®ä¿¡æ¯","é€»è¾‘æˆ–æ¨ç†ç¼ºé™·","åŒ…å«æ— å…³ä¿¡æ¯","ç½®ä¿¡åº¦ä¸å½“"],
    commentTitle:"ğŸ“ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰",
    status:"çŠ¶æ€ï¼š",
    saved:"å·²ä¿å­˜ âœ“",
    save:"ğŸ’¾ ä¿å­˜",
    saveNext:"â¡ï¸ ä¿å­˜å¹¶ä¸‹ä¸€ä¾‹",
    nextUnfinished:"â­ï¸ è·³è‡³ä¸‹ä¸€ä¸ªæœªå®Œæˆ",
    loading:c=>`æ­£åœ¨è½½å…¥ ${c} ä¸ª JSON â€¦`,
    loaded:(a,c)=>`å·²è½½å…¥ ${a} / ${c} â€¦`,
    progressText:(d,t)=>`${d} / ${t}`,
    ds_struct:"structured_ehr",
    ds_note:"unstructured_note",
    t_mort_title:"In-hospital mortality prediction",
    t_mort_desc:ds=>`åŸºäº ${ds}ï¼Œåˆ¤æ–­æ‚£è€…æ˜¯å¦åœ¨ä½é™¢æœŸé—´æ­»äº¡ã€‚`,
    t_read_title:"30-day readmission prediction",
    t_read_desc:ds=>`åŸºäº ${ds}ï¼Œåˆ¤æ–­æ‚£è€…åœ¨å‡ºé™¢å30å¤©å†…æ˜¯å¦å†æ¬¡å…¥é™¢ã€‚`,
    modalTitle:"æäº¤ / å¯¼å‡º",
    modalAnnot:"è¯„ä¼°è€… ID / å§“å",
    modalNote:"é™„åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰",
    modalCancel:"å–æ¶ˆ",
    modalExport:"å¯¼å‡º JSON",
    needAnnot:"è¯·å…ˆå¡«å†™è¯„ä¼°è€… ID/å§“åå†å¯¼å‡ºã€‚",
    autoScan:"æ­£åœ¨è‡ªåŠ¨æ‰«æ",
    reScanTip:"å·²å¼€å§‹é‡æ–°æ‰«æâ€¦",
    answer:"æ¨¡å‹è¾“å‡º",
    label:"çœŸå®æ ‡ç­¾",
    path:"è·¯å¾„",
    tabsHome:"ğŸ  /",
    tabsMort:"mortality",
    tabsRead:"readmission",
    // æ–°å¢
    tabAll:"å…¨éƒ¨ Case",
    tabSampled:"æŠ½æ · Case",
    sampleSizeLabel:"æ¯ä¸ªä»»åŠ¡æŠ½æ ·æ•°ï¼š",
  },
  en: {
    brand:"ğŸ©º Clinical Reasoning Survey",
    export:"â¬‡ï¸ Submit / Export",
    import:"â†©ï¸ Import",
    rescan:"ğŸ”„ Rescan",
    searchPH:"ğŸ” Search by case ID, model, or pathâ€¦",
    toggleHide:"Only Unfinished",
    toggleShuffle:"Shuffle",
    empty1:'Scanning <code>cases/</code>â€¦ If it hangs, ensure the directory is accessible from the same origin.',
    empty2:'Expected layout: <code>cases/&lt;structured_ehr|unstructured_note&gt;/&lt;mimic-iv-mortality|mimic-iv-readmission&gt;/*.json</code>',
    progressLabel:"Progress",
    storageHint:"Data stays in your browser (LocalStorage). Export to JSON anytime.",
    listNo:"No cases match the current filters.",
    done:"Done",
    todo:"Unfinished",
    model:"Model",
    inputTitle:"ğŸ§¾ Input (patient case)",
    thinkTitle:"ğŸ§  Model reasoning (think)",
    alTitle:"âœ… Model output (answer) & ground truth (label)",
    rawTitle:"ğŸ§© Raw JSON",
    rateTitles:["Clinical accuracy & safety","Reasoning & completeness","Clarity & clinical usefulness"],
    rateHint:"Rate 1 (very poor) â€” 5 (excellent). Click stars to set/update.",
    checkTitle:"ğŸ” Error checklist (multi-select)",
    checks:["Factual inconsistency / hallucination","Missing key information","Logical/reasoning flaw","Irrelevant information","Miscalibrated confidence"],
    commentTitle:"ğŸ“ Notes (optional)",
    status:"Status:",
    saved:"Saved âœ“",
    save:"ğŸ’¾ Save",
    saveNext:"â¡ï¸ Save & Next",
    nextUnfinished:"â­ï¸ Next unfinished",
    loading:c=>`Loading ${c} JSON â€¦`,
    loaded:(a,c)=>`Loaded ${a} / ${c} â€¦`,
    progressText:(d,t)=>`${d} / ${t}`,
    ds_struct:"structured_ehr",
    ds_note:"unstructured_note",
    t_mort_title:"In-hospital mortality prediction",
    t_mort_desc:ds=>`Based on ${ds}, determine whether the patient dies during the hospital stay.`,
    t_read_title:"30-day readmission prediction",
    t_read_desc:ds=>`Based on ${ds}, determine whether the patient is readmitted within 30 days after discharge.`,
    modalTitle:"Submit / Export",
    modalAnnot:"Annotator ID / Name",
    modalNote:"Extra note (optional)",
    modalCancel:"Cancel",
    modalExport:"Export JSON",
    needAnnot:"Please enter annotator ID/name before exporting.",
    autoScan:"Auto-scanning",
    reScanTip:"Rescanningâ€¦",
    answer:"Answer",
    label:"Label",
    path:"Path",
    tabsHome:"ğŸ  /",
    tabsMort:"mortality",
    tabsRead:"readmission",
    // æ–°å¢
    tabAll:"All Cases",
    tabSampled:"Sampled Cases",
    sampleSizeLabel:"Sample size per task:",
  }
};
let LANG = (localStorage.getItem(LANG_KEY) || "en");
const $ = sel => document.querySelector(sel);

/* ===========================
 * Meta & constants
 * =========================== */
const ROOT_BASE = "cases/";
const TASK_META = {
  "mimic-iv-mortality": {
    key:"mimic-iv-mortality",
    title: () => (LANG==="zh" ? I18N.zh.t_mort_title : I18N.en.t_mort_title),
    desc: (dsLabel) => (LANG==="zh" ? I18N.zh.t_mort_desc(dsLabel) : I18N.en.t_mort_desc(dsLabel))
  },
  "mimic-iv-readmission": {
    key:"mimic-iv-readmission",
    title: () => (LANG==="zh" ? I18N.zh.t_read_title : I18N.en.t_read_title),
    desc: (dsLabel) => (LANG==="zh" ? I18N.zh.t_read_desc(dsLabel) : I18N.en.t_read_desc(dsLabel))
  }
};
const DATASET_LABEL = {
  "structured_ehr": () => (LANG==="zh" ? I18N.zh.ds_struct : I18N.en.ds_struct),
  "unstructured_note": () => (LANG==="zh" ? I18N.zh.ds_note : I18N.en.ds_note),
};
const SIMPLE_TASK_TAG = (task) => task==="mimic-iv-mortality" ? (LANG==="zh"?I18N.zh.tabsMort:I18N.en.tabsMort) : (LANG==="zh"?I18N.zh.tabsRead:I18N.en.tabsRead);

const COMBOS = [
  {id:"structured_ehr::mimic-iv-mortality"},
  {id:"structured_ehr::mimic-iv-readmission"},
  {id:"unstructured_note::mimic-iv-mortality"},
  {id:"unstructured_note::mimic-iv-readmission"},
];

const STORAGE_KEY = "humeval_responses_v3";
const PREF_KEY    = "humeval_prefs_v3";

let state = {
  cases: [],             // {id, datasetGroup, task, path, url, json}
  byCombo: new Map(),
  activeCombo: COMBOS[0].id,
  activeIndex: -1,       // global index in state.cases
  filteredIdxs: [],
  prefs: { hideDone:false, shuffle:false, sampleSize: 5 }, // æ–°å¢æŠ½æ ·æ•°é‡
  responses: {},         // path -> response
  scanning:false,
  viewMode: 'all', // æ–°å¢ 'all' or 'sampled'
};

const viewModeContainerEl = $("#viewModeContainer");
const tabsEl = $("#tabs");
const caseListEl = $("#caseList");
const contentEl = $("#content");
const searchBoxEl = $("#searchBox");
const toggleHideDoneEl = $("#toggleHideDone");
const toggleShuffleEl = $("#toggleShuffle");
const progressBarEl = $("#progressBar");
const progressTextEl = $("#progressText");
const exportBtnEl = $("#exportBtn");
const importBtnEl = $("#importBtn");
const importFileEl = $("#importFile");
const toastEl = $("#toast");
const autoStatusEl = $("#autoStatus");
const rescanBtn = $("#rescanBtn");

/* ===========================
 * Utils
 * =========================== */
function t(key, ...args){
  const v = I18N[LANG][key];
  return typeof v === "function" ? v(...args) : v;
}
function savePrefs(){ localStorage.setItem(PREF_KEY, JSON.stringify(state.prefs)); }
function loadPrefs(){
  try{ const p = JSON.parse(localStorage.getItem(PREF_KEY)||"{}"); state.prefs = Object.assign(state.prefs, p); }catch(e){}
  setToggle(toggleHideDoneEl, state.prefs.hideDone);
  setToggle(toggleShuffleEl, state.prefs.shuffle);
}
function showToast(msg=t("saved")){ toastEl.textContent = msg; toastEl.style.display="block"; setTimeout(()=>toastEl.style.display="none", 1200); }
function downloadJSON(obj, filename="human_eval_results.json"){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function fmtDate(d=new Date()){ const s = d.toISOString(); return s.substring(0,19)+"Z"; }
function cmpCaseId(a,b){
  const na=a.id.match(/\d+/g)?.map(Number)||[], nb=b.id.match(/\d+/g)?.map(Number)||[]; // best-effort numeric primary
  const ka=na.length?na[0]:a.id, kb=nb.length?nb[0]:b.id;
  return (ka>kb)-(ka<kb);
}
function computeProgress(){
  const ids = state.filteredIdxs;
  let done = 0;
  for(const idx of ids){
    const key = state.cases[idx].path;
    if(state.responses[key] && isCompleted(state.responses[key])) done++;
  }
  progressTextEl.textContent = t("progressText", done, ids.length);
  const pct = ids.length ? Math.round(done*100/ids.length) : 0;
  progressBarEl.style.width = pct + "%";
}
function isCompleted(resp){
  return [resp?.score_accuracy, resp?.score_reasoning, resp?.score_clarity].every(x=> Number.isInteger(x) && x>=1 && x<=5);
}
function setToggle(el,on){ el.classList.toggle("active", !!on); }
function getComboId(ds,task){ return `${ds}::${task}`; }
function escapeHtml(s){
  if(s===null||s===undefined) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function ensureActiveVisible(){
  const path = state.cases[state.activeIndex]?.path;
  if(!path) return;
  const el = caseListEl.querySelector(`.item[data-key="${CSS.escape(path)}"]`);
  if(el) el.scrollIntoView({block:"nearest"});
}
/* ===========================
 * Language apply
 * =========================== */
function applyI18n(){
  document.title = "ä¸´åºŠæ¨ç†é—®å·";
  $("#brand").textContent = t("brand");
  exportBtnEl.textContent = t("export");
  importBtnEl.textContent = t("import");
  rescanBtn.textContent = t("rescan");
  searchBoxEl.placeholder = t("searchPH");
  toggleHideDoneEl.textContent = t("toggleHide");
  toggleShuffleEl.textContent = t("toggleShuffle");
  $("#emptyMsg1").innerHTML = t("empty1");
  $("#emptyMsg2").innerHTML = t("empty2");
  $("#progressLabel").textContent = t("progressLabel");
  $("#storageHint").textContent = t("storageHint");
  autoStatusEl.innerHTML = `${t("autoScan")} <span class="kbd">${ROOT_BASE}</span>â€¦`;
  renderViewControls(); // æ¸²æŸ“è§†å›¾æ¨¡å¼
  renderTabs();
  refreshList(true);
  if (state.activeIndex>=0) renderCase(state.cases[state.activeIndex]); // å³æ—¶æ›´æ–°ä¸­è‹±æ–‡å†…å®¹
}

async function autoScanAll(){
  if (state.scanning) return;
  state.scanning = true;
  exportBtnEl.disabled = true;
  autoStatusEl.textContent = (LANG === "zh" ? "æ­£åœ¨åŠ è½½æ¸…å•â€¦" : "Loading manifestâ€¦");
  contentEl.innerHTML = `<div style="padding:16px"><div class="muted">${t("loading", "â€¦")}</div></div>`;
  state.cases = [];
  state.byCombo = new Map(); for(const c of COMBOS) state.byCombo.set(c.id, []);

  try {
    // æ­¥éª¤ 1: è·å–æ¸…å•æ–‡ä»¶
    const manifestRes = await fetch('file-manifest.json', { cache: "no-cache" });
    if (!manifestRes.ok) throw new Error("Could not fetch file-manifest.json. Did you generate it?");
    const manifest = await manifestRes.json();

    // æ­¥éª¤ 2: åˆ›å»ºæ‰€æœ‰ fetch ä»»åŠ¡
    const allFilePromises = [];
    for (const comboId in manifest) {
      if (manifest.hasOwnProperty(comboId)) {
        manifest[comboId].forEach(filePath => {
          allFilePromises.push(
            fetch(filePath, { cache: "no-cache" })
              .then(res => {
                if (!res.ok) throw new Error(`Failed to load ${filePath}`);
                return res.json();
              })
              .then(js => {
                if (!js || typeof js !== "object") return null;
                const pathParts = filePath.split('/');
                const id = decodeURIComponent(pathParts.pop().replace(/\.json$/, ""));
                const task = pathParts.pop();
                const datasetGroup = pathParts.pop();
                return { id, datasetGroup, task, path: filePath, json: js };
              })
              .catch(e => {
                console.warn(e);
                return null; // å¦‚æœæŸä¸ªæ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¿”å› null
              })
          );
        });
      }
    }

    // æ­¥éª¤ 3: å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ fetch
    const results = await Promise.all(allFilePromises);

    // æ­¥éª¤ 4: å¡«å…… state.cases
    state.cases = results.filter(Boolean); // è¿‡æ»¤æ‰åŠ è½½å¤±è´¥çš„ null
    let totalFound = state.cases.length;

    // æ­¥éª¤ 5: æ’åºå’Œåˆ†ç»„
    state.cases.sort(cmpCaseId);
    state.byCombo = new Map(); for(const c of COMBOS) state.byCombo.set(c.id, []);
    for(let i = 0; i < state.cases.length; i++){
      const it = state.cases[i];
      const comboId = getComboId(it.datasetGroup, it.task);
      if(state.byCombo.has(comboId)){
          state.byCombo.get(comboId).push(i);
      }
    }

    // æ­¥éª¤ 6: æ¸²æŸ“ UI
    renderViewControls();
    renderTabs();
    refreshList();
    if (state.filteredIdxs.length) openCaseByFilteredIndex(0);
    exportBtnEl.disabled = state.cases.length === 0;
    autoStatusEl.textContent = (LANG === "zh" ? `å·²å‘ç° ${totalFound} ä¸ªç—…ä¾‹` : `Discovered ${totalFound} cases`);
  } catch(err) {
    console.error(err);
    const errorMsg = LANG === "zh"
      ? "æ‰«æå¤±è´¥ï¼ˆè¯·ç¡®è®¤æ ¹ç›®å½•ä¸‹çš„ `file-manifest.json` æ–‡ä»¶å­˜åœ¨ä¸”å¯è®¿é—®ï¼‰"
      : "Scan failed (ensure `file-manifest.json` exists and is accessible in the root)";
    autoStatusEl.textContent = errorMsg;
    contentEl.innerHTML = `<div style="padding:16px"><div class="danger">${escapeHtml(autoStatusEl.textContent)}</div><div class="hint">${t("empty2")}</div></div>`;
  } finally {
    state.scanning = false;
  }
}

/* list directory by parsing simple index HTML (Apache/nginx/python -m http.server) */
async function listJsonFiles(dirUrl){
  const url = new URL(dirUrl, location.href).toString();
  const res = await fetch(url, {cache:"no-cache"});
  if (!res.ok) throw new Error(`Cannot list ${url}: ${res.status}`);
  const txt = await res.text();
  const tmp = document.createElement("div");
  tmp.innerHTML = txt;
  const links = Array.from(tmp.querySelectorAll("a[href]")).map(a => a.getAttribute("href"));
  const files = [];
  for(const href of links){
    if (!href) continue;
    const abs = new URL(href, url).toString();
    const name = abs.split("/").filter(Boolean).pop() || "";
    if (name.toLowerCase().endsWith(".json")) files.push(abs);
  }
  return files;
}
async function fetchJson(url){
  const res = await fetch(url, {cache:"no-cache"});
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

/* ===========================
 * Tabs & descriptions
 * =========================== */
function comboLabel(comboId){
  const [ds, task] = comboId.split("::");
  return `${ds} ${SIMPLE_TASK_TAG(task)}`;
}
// æ–°å¢ï¼šæ¸²æŸ“ä¸»è§†å›¾åˆ‡æ¢ï¼ˆå…¨éƒ¨/æŠ½æ ·ï¼‰
function renderViewControls() {
    viewModeContainerEl.innerHTML = '';

    const allBtn = document.createElement('div');
    allBtn.className = 'view-mode-tab' + (state.viewMode === 'all' ? ' active' : '');
    allBtn.textContent = t('tabAll');
    allBtn.onclick = () => {
        state.viewMode = 'all';
        renderViewControls();
        refreshList(true);
    };
    viewModeContainerEl.appendChild(allBtn);

    const sampledBtn = document.createElement('div');
    sampledBtn.className = 'view-mode-tab' + (state.viewMode === 'sampled' ? ' active' : '');
    sampledBtn.textContent = t('tabSampled');
    sampledBtn.onclick = () => {
        state.viewMode = 'sampled';
        renderViewControls();
        refreshList(true);
    };
    viewModeContainerEl.appendChild(sampledBtn);

    if (state.viewMode === 'sampled') {
        const settingsDiv = document.createElement('div');
        settingsDiv.className = 'sample-settings';
        const label = document.createElement('span');
        label.className = 'hint';
        label.textContent = t('sampleSizeLabel');
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 1;
        input.value = state.prefs.sampleSize;
        input.onchange = (e) => {
            const val = parseInt(e.target.value, 10);
            if (val > 0) {
                state.prefs.sampleSize = val;
                savePrefs();
                refreshList(true);
            }
        };
        settingsDiv.appendChild(label);
        settingsDiv.appendChild(input);
        viewModeContainerEl.appendChild(settingsDiv);
    }
}

function renderTabs(){
  tabsEl.innerHTML = "";
  const home = document.createElement("a");
  home.className = "home-tab";
  home.textContent = t("tabsHome");
  home.href = ".";
  home.title = ".";
  tabsEl.appendChild(home);

  for(const c of COMBOS){
    const b=document.createElement("div");
    b.className="tab"+(state.activeCombo===c.id?" active":"");
    b.textContent = comboLabel(c.id);
    b.onclick = ()=>{ state.activeCombo=c.id; renderTabs(); refreshList(true); };
    tabsEl.appendChild(b);
  }
}

/* ===========================
 * Responses persistence
 * =========================== */
function loadResponses(){ try{ state.responses = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}") }catch(e){ state.responses = {} } }
function persistResponses(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.responses)); }

/* ===========================
 * Filtering & list
 * =========================== */
function refreshList(preserve=false){
  const prevPath = (state.activeIndex>=0 ? state.cases[state.activeIndex].path : null);
  const prevScroll = caseListEl.scrollTop;

  const comboIdxs = state.byCombo.get(state.activeCombo)||[];
  let idxs;

  // æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®è§†å›¾æ¨¡å¼å†³å®šåˆå§‹åˆ—è¡¨
  if (state.viewMode === 'sampled') {
    const fullList = comboIdxs.slice();
    const shuffled = shuffle(fullList); // å¤ç”¨å·²æœ‰çš„ shuffle å‡½æ•°
    const sampleSize = state.prefs.sampleSize || 5;
    idxs = shuffled.slice(0, sampleSize);
  } else { // 'all' mode
    idxs = comboIdxs.slice();
  }

  const q = searchBoxEl.value.trim().toLowerCase();
  if (q){
    idxs = idxs.filter(i=>{
      const c = state.cases[i];
      const path = c.path.toLowerCase();
      const model = (c.json?.model || "").toLowerCase();
      return c.id.toLowerCase().includes(q) || path.includes(q) || model.includes(q);
    });
  }
  if (state.prefs.hideDone){
    idxs = idxs.filter(i=>{
      const k = state.cases[i].path;
      return !(state.responses[k] && isCompleted(state.responses[k]));
    });
  }
  if (state.prefs.shuffle){ idxs = shuffle(idxs); }

  state.filteredIdxs = idxs;
  renderList();

  computeProgress();

  if (preserve && prevPath){
    const k = state.filteredIdxs.findIndex(i=> state.cases[i].path===prevPath);
    if (k>=0) { state.activeIndex = state.filteredIdxs[k]; highlightActive(prevPath); ensureActiveVisible(); }
  } else {
    // å¦‚æœåˆ—è¡¨æ›´æ–°ä¸”æ²¡æœ‰ä¿ç•™é¡¹ï¼Œé»˜è®¤æ‰“å¼€ç¬¬ä¸€ä¸ª
    if (state.filteredIdxs.length > 0) {
      openCaseByFilteredIndex(0);
    } else {
      contentEl.innerHTML = ''; // æ¸…ç©ºå†…å®¹åŒº
      state.activeIndex = -1;
    }
  }
  caseListEl.scrollTop = prevScroll;
}
function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function renderList(){
  caseListEl.innerHTML = "";
  if (!state.filteredIdxs.length){
    caseListEl.innerHTML = `<div class="muted" style="padding:8px 10px">${t("listNo")}</div>`;
    return;
  }
  for(let k=0;k<state.filteredIdxs.length;k++){
    const idx = state.filteredIdxs[k];
    const c = state.cases[idx];
    const key = c.path;
    const resp = state.responses[key];
    const done = resp && isCompleted(resp);

    const div = document.createElement("div");
    div.className = "item";
    div.dataset.key = key;
    div.onclick = ()=> openCaseByFilteredIndex(k);

    const title = document.createElement("div");
    title.innerHTML = `<div><b>${escapeHtml(c.id)}</b></div>
      <div class="meta">${escapeHtml(DATASET_LABEL[c.datasetGroup]())} / ${escapeHtml(TASK_META[c.task].title())}</div>`;

    const right = document.createElement("div");
    const badge1 = document.createElement("div");
    badge1.className = "badge " + (done ? "ok":"todo");
    badge1.dataset.role = "status";
    badge1.textContent = done ? t("done") : t("todo");
    right.style.display="flex"; right.style.gap="6px";
    right.appendChild(badge1);

    div.appendChild(title); div.appendChild(right);
    caseListEl.appendChild(div);
  }
  highlightActive(state.cases[state.activeIndex]?.path);
}
function highlightActive(path){
  caseListEl.querySelectorAll(".item").forEach(el=> el.classList.remove("active"));
  if (!path) return;
  const el = caseListEl.querySelector(`.item[data-key="${CSS.escape(path)}"]`);
  if (el) el.classList.add("active");
}
function updateListItemStatus(path){
  const el = caseListEl.querySelector(`.item[data-key="${CSS.escape(path)}"] [data-role="status"]`);
  if (!el) return;
  const resp = state.responses[path];
  const done = resp && isCompleted(resp);
  el.className = "badge " + (done ? "ok":"todo");
  el.textContent = done ? t("done") : t("todo");
}

/* ===========================
 * Open case & render content
 * =========================== */
function openCaseByFilteredIndex(k){
  if (k<0 || k>=state.filteredIdxs.length) return;
  state.activeIndex = state.filteredIdxs[k];
  const c = state.cases[state.activeIndex];
  renderCase(c);
  highlightActive(c.path);
  ensureActiveVisible();
}
function renderCase(c){
  const key = c.path;
  const js = c.json || {};
  const model = js.model ?? "â€”";
  const answer = js.answer;
  const label  = js.label;

  const inputText = (LANG==="zh" && js.input_cn) ? js.input_cn : js.input;
  const thinkText = (LANG==="zh" && js.think_cn) ? js.think_cn : js.think;

  const resp = state.responses[key] || {
    path: c.path, datasetGroup:c.datasetGroup, task:c.task, case_id:c.id,
    score_accuracy:0, score_reasoning:0, score_clarity:0,
    err_factual:false, err_missing:false, err_logic:false, err_irrelevant:false, err_calibration:false,
    comment:"", createdAt:fmtDate(new Date()), updatedAt:fmtDate(new Date())
  };

  contentEl.innerHTML = `

    <details open style="margin-top:12px"> <summary>${t("inputTitle")}</summary> <pre>${escapeHtml(inputText ?? "â€”")}</pre> </details>
    <details open> <summary>${t("thinkTitle")}</summary> <pre>${escapeHtml(thinkText ?? "â€”")}</pre> </details>
    <details open>
      <summary>${t("alTitle")}</summary>
      <div class="al-wrap" style="margin-top:6px; display:flex; flex-wrap:wrap; gap:8px;">
        <span class="pill"><b>${t("answer")}:</b> ${escapeHtml(String(answer))}</span>
        <span class="pill"><b>${t("label")}:</b> ${escapeHtml(String(label))}</span>
        <!-- <span class="pill"><b>${t("path")}:</b> <span style="word-break:break-all">${escapeHtml(c.path)}</span></span> -->
      </div>
    </details>
    <details> <summary>${t("rawTitle")}</summary> <pre>${escapeHtml(JSON.stringify(js, null, 2))}</pre> </details>
    <div class="panel" style="padding:12px; margin-top:12px">
      <div class="grid3">
        <div class="block" style="border:none; padding:0; background:transparent">
          <div class="muted" style="margin-bottom:6px">${t("rateTitles")[0]}</div>
          ${renderStars("score_accuracy", resp.score_accuracy)}
        </div>
        <div class="block" style="border:none; padding:0; background:transparent">
          <div class="muted" style="margin-bottom:6px">${t("rateTitles")[1]}</div>
          ${renderStars("score_reasoning", resp.score_reasoning)}
        </div>
        <div class="block" style="border:none; padding:0; background:transparent">
          <div class="muted" style="margin-bottom:6px">${t("rateTitles")[2]}</div>
          ${renderStars("score_clarity", resp.score_clarity)}
        </div>
      </div>
      <div class="hint" style="margin-top:6px">${t("rateHint")}</div>
    </div>
    <div class="grid2" style="margin-top:12px">
      <div class="block checklist" style="background:#fff">
        <div style="font-weight:700; margin-bottom:6px">${t("checkTitle")}</div>
        ${renderCheck("err_factual", t("checks")[0])}
        ${renderCheck("err_missing", t("checks")[1])}
        ${renderCheck("err_logic", t("checks")[2])}
        ${renderCheck("err_irrelevant", t("checks")[3])}
        ${renderCheck("err_calibration", t("checks")[4])}
      </div>
      <div class="block" style="background:#fff">
        <div style="font-weight:700; margin-bottom:6px">${t("commentTitle")}</div>
        <textarea id="commentBox" rows="8" placeholder="">${escapeHtml(resp.comment||"")}</textarea>
      </div>
    </div>
    <div class="savebar">
      <div class="muted">
        <b>${t("status")}</b>
        <span id="statusInline">${isCompleted(resp) ? `<span style="color: var(--ok)">${t("done")}</span>` : `<span class="danger">${t("todo")}</span>`}</span>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn secondary" id="btnSave">${t("save")}</button>
        <button class="btn" id="btnSaveNext">${t("saveNext")}</button>
        <button class="btn ghost" id="btnNextUnrated">${t("nextUnfinished")}</button>
      </div>
    </div>
  `;

  contentEl.querySelectorAll(".star").forEach(el=>{
    el.addEventListener("click", ()=>{
      const field = el.dataset.field; const val = +el.dataset.val; const r = getCurrentResponse(c);
      r[field] = val; r.updatedAt = fmtDate(new Date()); state.responses[key]=r; persistResponses();
      renderStarGroup(field, val); realtimeStatusUpdate(c); showToast();
    });
  });
  ["err_factual","err_missing","err_logic","err_irrelevant","err_calibration"].forEach(f=>{
    const box = $("#"+f);
    if (box){ box.checked = !!resp[f]; box.addEventListener("change", ()=>{
      const r = getCurrentResponse(c); r[f] = !!box.checked; r.updatedAt=fmtDate(new Date());
      state.responses[key]=r; persistResponses(); showToast();
    }) }
  });
  $("#commentBox").addEventListener("input", ()=>{
    const r=getCurrentResponse(c); r.comment = $("#commentBox").value; r.updatedAt=fmtDate(new Date());
    state.responses[key]=r; persistResponses();
  });

  $("#btnSave").onclick = ()=>{ saveCurrentCase(c); showToast(); };
  $("#btnSaveNext").onclick = ()=>{ saveCurrentCase(c); jumpNext(1); };
  $("#btnNextUnrated").onclick = ()=> jumpNextUnrated();
}
function renderStars(field, current){
  const stars = [1,2,3,4,5].map(v=>`<span class="${(current>=v) ? "star on":"star"}" data-field="${field}" data-val="${v}" title="${v}">â˜…</span>`).join("");
  return `<div class="stars" id="grp_${field}">${stars}</div>`;
}
function renderStarGroup(field,current){
  const grp = $("#grp_"+field); if(!grp) return;
  grp.querySelectorAll(".star").forEach(el=> el.classList.toggle("on", (+el.dataset.val)<=current));
}
function renderCheck(id,label){
  return `<label><input id="${id}" type="checkbox" /><div><div><b>${escapeHtml(label)}</b></div></div></label>`;
}
function getCurrentResponse(c){
  const key=c.path, existing=state.responses[key]||{};
  return Object.assign({
    path:c.path, datasetGroup:c.datasetGroup, task:c.task, case_id:c.id, answer:c.json?.answer, label:c.json?.label,
    score_accuracy:0, score_reasoning:0, score_clarity:0, err_factual:false, err_missing:false, err_logic:false, err_irrelevant:false, err_calibration:false,
    comment:"", createdAt:fmtDate(new Date()), updatedAt:fmtDate(new Date()),
  }, existing);
}
function saveCurrentCase(c){
  const key=c.path; const r=getCurrentResponse(c); r.updatedAt=fmtDate(new Date());
  state.responses[key]=r; persistResponses(); realtimeStatusUpdate(c);
}
function realtimeStatusUpdate(c){
  const key=c.path, r=state.responses[key]; const done = isCompleted(r);
  const statusEl = $("#statusInline");
  statusEl.innerHTML = done ? `<span style="color: var(--ok)">${t("done")}</span>` : `<span class="danger">${t("todo")}</span>`;
  updateListItemStatus(key); computeProgress();
}
function jumpNext(step=1){
  if (!state.filteredIdxs.length) return;
  const pos = state.filteredIdxs.indexOf(state.activeIndex);
  const nextk = (pos + step + state.filteredIdxs.length) % state.filteredIdxs.length;
  openCaseByFilteredIndex(nextk);
}
function jumpNextUnrated(){
  if (!state.filteredIdxs.length) return;
  const pos = state.filteredIdxs.indexOf(state.activeIndex);
  for(let off=1; off<=state.filteredIdxs.length; off++){
    const k=(pos+off)%state.filteredIdxs.length;
    const idx=state.filteredIdxs[k], key=state.cases[idx].path;
    if(!(state.responses[key] && isCompleted(state.responses[key]))){ openCaseByFilteredIndex(k); return; }
  }
  showToast(LANG==="zh"?"æ²¡æœ‰æœªå®Œæˆçš„ç—…ä¾‹":"No unfinished cases");
}

/* ===========================
 * Export / Import
 * =========================== */
function exportResultsFlow(){
  const mask = $("#exportModalMask");
  $("#exportTitle").textContent = t("modalTitle");
  $("#exportCancel").textContent = t("modalCancel");
  $("#exportConfirm").textContent = t("modalExport");
  $("#annotatorInput").placeholder = t("modalAnnot");
  $("#exportNote").placeholder = t("modalNote");
  mask.style.display="flex"; mask.setAttribute("aria-hidden","false");
  $("#annotatorInput").focus();
}
function closeExportModal(){
  $("#exportModalMask").style.display="none";
  $("#exportModalMask").setAttribute("aria-hidden","true");
}
function doExport(annotator, extraNote){
  if (!annotator || !annotator.trim()){
    showToast(t("needAnnot")); $("#annotatorInput").focus(); return;
  }
  const results = [];
  for(const c of state.cases){
    const key=c.path, r=state.responses[key];
    if (!r) continue;
    results.push({
      id:c.id, dataset_group:c.datasetGroup, task:c.task, path:c.path, model:c.json?.model ?? null,
      answer:c.json?.answer ?? null, label:c.json?.label ?? null,
      rating:{
        clinical_accuracy_safety: r.score_accuracy || 0, reasoning_completeness: r.score_reasoning || 0,
        clarity_usefulness: r.score_clarity || 0
      },
      errors:{
        factual_inconsistency: !!r.err_factual, missing_key_info: !!r.err_missing, logical_flaw: !!r.err_logic,
        irrelevant_content: !!r.err_irrelevant, miscalibrated_confidence: !!r.err_calibration
      },
      comment: r.comment || "", annotator_id: annotator, createdAt: r.createdAt, updatedAt: r.updatedAt
    });
  }
  const meta = {
    tool:"clinical-human-eval-error-analysis", version:"3.1.0", exportedAt: fmtDate(new Date()),
    annotator_id: annotator, note: extraNote || "", dataset_root: ROOT_BASE, combos: COMBOS.map(c=> c.id), language: LANG
  };
  // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æ ‡æ³¨è€…IDå‘½åæ–‡ä»¶
  const safeAnnotator = annotator.replace(/[^a-zA-Z0-9_-]/g, '_'); // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œç¡®ä¿æ–‡ä»¶ååˆæ³•
  downloadJSON({meta, results}, `${safeAnnotator}_eval_results.json`);
  closeExportModal();
}
function mergeImportedResults(obj){
  const arr = Array.isArray(obj?.results) ? obj.results : (Array.isArray(obj) ? obj : []);
  let merged=0;
  for(const r of arr){
    if (!r?.path) continue;
    state.responses[r.path] = {
      path:r.path, datasetGroup:r.dataset_group, task:r.task, case_id:r.id, answer:r.answer, label:r.label,
      score_accuracy: r.rating?.clinical_accuracy_safety || 0, score_reasoning: r.rating?.reasoning_completeness || 0, score_clarity: r.rating?.clarity_usefulness || 0,
      err_factual: !!r.errors?.factual_inconsistency, err_missing: !!r.errors?.missing_key_info, err_logic: !!r.errors?.logical_flaw,
      err_irrelevant: !!r.errors?.irrelevant_content, err_calibration: !!r.errors?.miscalibrated_confidence,
      comment:r.comment || "", createdAt: r.createdAt || fmtDate(new Date()), updatedAt: r.updatedAt || fmtDate(new Date()),
    };
    merged++;
  }
  persistResponses();
  showToast((LANG==="zh" ? `å·²åˆå¹¶ ${merged} æ¡ç»“æœ` : `Merged ${merged} items`));
  refreshList(true);
  if (state.activeIndex>=0) renderCase(state.cases[state.activeIndex]);
}

/* ===========================
 * Events
 * =========================== */
document.addEventListener("DOMContentLoaded", ()=>{
  $("#langSelect").value = LANG;
  $("#langSelect").addEventListener("change", ()=>{
    LANG = $("#langSelect").value || "zh";
    localStorage.setItem(LANG_KEY, LANG);
    applyI18n();
  });

  loadPrefs(); loadResponses();
  applyI18n(); // applyI18nä¼šè°ƒç”¨renderViewControlså’ŒrenderTabs
  autoScanAll();

  rescanBtn.addEventListener("click", ()=>{ showToast(t("reScanTip")); autoScanAll(); });
  searchBoxEl.addEventListener("input", ()=> refreshList(true));
  toggleHideDoneEl.addEventListener("click", ()=>{ state.prefs.hideDone=!state.prefs.hideDone; savePrefs(); setToggle(toggleHideDoneEl,state.prefs.hideDone); refreshList(true); });
  toggleShuffleEl.addEventListener("click", ()=>{ state.prefs.shuffle=!state.prefs.shuffle; savePrefs(); setToggle(toggleShuffleEl,state.prefs.shuffle); refreshList(true); });
  exportBtnEl.addEventListener("click", exportResultsFlow);
  $("#exportCancel").addEventListener("click", closeExportModal);
  $("#exportConfirm").addEventListener("click", ()=>{
    const annot = $("#annotatorInput").value.trim();
    const note = $("#exportNote").value.trim();
    doExport(annot, note);
  });
  $("#exportModalMask").addEventListener("click", (e)=>{ if (e.target === $("#exportModalMask")) closeExportModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key==="Escape") closeExportModal(); });
  importBtnEl.addEventListener("click", ()=> importFileEl.click());
  importFileEl.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    try{ const txt=await f.text(); const obj=JSON.parse(txt); mergeImportedResults(obj); }
    catch(err){ alert(LANG==="zh"?"å¯¼å…¥å¤±è´¥ï¼šä¸æ˜¯æœ‰æ•ˆçš„ JSONã€‚":"Import failed: invalid JSON."); }
  });
});
</script>
</body>
</html>